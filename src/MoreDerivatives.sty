% Copyright (c) 2023 Jesse Straat
% 
% This software is released under the MIT License.
% https://opensource.org/licenses/MIT

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{MoreDerivatives}[2023-01-14 Provides extra kinds of derivatives]

% Technical packages %
\RequirePackage{kvoptions}
\RequirePackage{xparse}
\RequirePackage{xstring}

% Other Packages %
\RequirePackage{graphicx}
\RequirePackage{amsmath}

% Setting up options
\SetupKeyvalOptions{}

    \DeclareStringOption[d]{default}    % Can be any differential option

\ProcessKeyvalOptions*

% Defines local parameters
\newcommand{\MoreDerivatives@totalorder}{}
\newcommand{\MoreDerivatives@numerator}{}
\newcommand{\MoreDerivatives@denominator}{}

\NewDocumentCommand{\differential}{ O{\MoreDerivatives@default} }{
    \IfStrEqCase{#1}{% Differential options
        {d}{\mathrm{d}} % Regular differential
        {pd}{\partial}  % Partial derivatives
        {id}{d}         % Italic differential
        {rho}{          % Upside-down rho
            \text{\m@th\raisebox{\depth}{\rotatebox[origin=c]{180}{\(\rho\)}}}
        }%
        {vrho}{         % Upside-down varrho
            \text{\m@th\raisebox{\depth}{\rotatebox[origin=c]{180}{\(\varrho\)}}}
        }%
    }[\PackageError{MoreDerivatives}{%
        Error: invalid differential option: #1
    }{%
        See the documentation for a list of options
    }]    % Returns error if invalid option
}

% Derivative (inspiration taken from diffcoeff)
% #1(*) = append differentiand boolean (as in diffcoeff)
% #2(clist) = order of derivative per variable
% #3(string) = derivative order override (ex. \drv[1][2] fx produces d^2f/dx)
% #4(.string.) = differential option
% #5(string) = differentiand
% #6(.string.) = differential option override for variables
% #7(clist) = variables to be differentiated to
% #8(string) = point of evaluation
\NewDocumentCommand{\drv}{ s O{1} o >{\TrimSpaces} D..{\MoreDerivatives@default} m d.. m !o}{%
    % Determine total order
    \IfValueTF {#3} {%
        \renewcommand{\MoreDerivatives@totalorder}{#3}
    }{%
        \renewcommand{\MoreDerivatives@totalorder}{} % TODO: calculate order
    }%
    %
    % Numerator
    \IfBooleanTF{#1}{%
        \renewcommand{\MoreDerivatives@numerator}{\differential[#4]^{\MoreDerivatives@totalorder}}
    }{%
        \renewcommand{\MoreDerivatives@numerator}{\differential[#4]^{\MoreDerivatives@totalorder} #5}
    }%
    %
    % Denominator
    % TODO: add higher-order derivatives
    \IfValueTF{#6}{%
        \renewcommand{\MoreDerivatives@denominator}{\differential[#6] #7}
    }{%
        \renewcommand{\MoreDerivatives@denominator}{\differential[#4] #7}
    }%
    %
    % Derivative
    \IfValueT{#8}{\left(}
    \frac{\MoreDerivatives@numerator}{\MoreDerivatives@denominator}
    \IfValueT{#8}{\right)_{\mkern-4mu #8}}
    \IfBooleanT{#1}{\left(#5\right)}
}%